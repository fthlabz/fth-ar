<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sanal Keşif | Pro Motor</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:ital,wght@1,600&display=swap" rel="stylesheet">
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>

    <style>
        :root { --bg-dark: #050505; --glass-bg: rgba(22, 22, 24, 0.85); --glass-border: 1px solid rgba(255, 255, 255, 0.15); --gold: #D4AF37; --text-main: #ffffff; --text-muted: #a1a1aa; }
        body { margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text-main); height: 100vh; }
        model-viewer { width: 100vw; height: 100vh; --poster-color: transparent; outline: none; }
        .ui-layer { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; z-index: 10; }
        
        /* Üst Menü */
        .top-bar { display: flex; justify-content: space-between; align-items: flex-start; pointer-events: auto; padding-top: env(safe-area-inset-top); }
        .brand { background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); padding: 8px 18px; border-radius: 20px; border: var(--glass-border); font-family: 'Playfair Display', serif; font-size: 16px; font-weight: 600; }
        .fav-btn { background: rgba(0,0,0,0.3); backdrop-filter: blur(10px); border: var(--glass-border); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; pointer-events: auto;}
        
        /* Alt Panel */
        .bottom-panel { pointer-events: auto; position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 400px; padding-bottom: env(safe-area-inset-bottom); }
        .info-card { background: var(--glass-bg); backdrop-filter: blur(25px); border: var(--glass-border); border-radius: 24px; padding: 18px; box-shadow: 0 25px 50px rgba(0,0,0,0.7); display: flex; flex-direction: column; gap: 15px; }
        .upper-row { display: flex; align-items: center; justify-content: space-between; }
        .nav-btn { width: 45px; height: 45px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; transition: 0.2s;}
        .nav-btn:active { background: white; color: black; }
        .text-content { flex: 1; text-align: center; display: flex; flex-direction: column; padding: 0 10px; }
        .product-title { font-family: 'Playfair Display', serif; font-size: 20px; margin: 4px 0; line-height: 1.2; }
        .price { font-size: 15px; font-weight: 700; color: var(--gold); }
        .size-info { font-size: 12px; color: var(--text-muted); }
        
        .action-row { display: flex; gap: 8px; }
        .btn-ar { flex: 1; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15); color: white; padding: 12px; border-radius: 14px; font-weight: 600; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 6px; cursor: pointer; }
        .btn-whatsapp { flex: 1.5; background: #25D366; color: white; padding: 12px; border-radius: 14px; font-weight: 700; font-size: 14px; display: flex; align-items: center; justify-content: center; text-decoration: none; }
        
        #loader { position: absolute; top:0; left:0; width:100%; height:100%; background: var(--bg-dark); z-index: 100; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .spinner { width: 35px; height: 35px; border: 3px solid #333; border-top: 3px solid var(--gold); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader"><div class="spinner"></div></div>

    <model-viewer id="ar-gosterici"
        ar ar-modes="webxr scene-viewer quick-look"
        camera-controls 
        environment-image="neutral"
        shadow-intensity="1.5" 
        auto-rotate>
        <button slot="ar-button" style="display: none;"></button>

        <div class="ui-layer">
            <div class="top-bar">
                <div class="brand">Sanal<span>Keşif</span></div>
                <div class="fav-btn" onclick="favoriToggle()"><svg width="20" height="20" stroke="white" fill="none" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></div>
            </div>

            <div class="bottom-panel">
                <div class="info-card">
                    <div class="upper-row">
                        <div class="nav-btn" onclick="degistir(-1)">
                            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
                        </div>
                        <div class="text-content">
                            <span class="size-info" id="urun-seri">KATEGORİ</span>
                            <h1 class="product-title" id="urun-adi">Yükleniyor...</h1>
                            <div><span class="price" id="urun-fiyat">0 TL</span> <span class="size-info" id="urun-olcu"></span></div>
                        </div>
                        <div class="nav-btn" onclick="degistir(1)">
                            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                        </div>
                    </div>

                    <div class="action-row">
                        <button class="btn-ar" onclick="arBaslat()">Evde Gör</button>
                        <a id="wp-link" href="#" target="_blank" class="btn-whatsapp">Sipariş Ver</a>
                    </div>
                </div>
            </div>
        </div>
    </model-viewer>

    <script>
        const KULLANICI = "fthlabz";
        const REPO = "fth-ar"; 
        const WP_NUMARA = "905XXXXXXXXXX"; 
        
        let vitrin = [];
        let aktifIndex = 0;
        const mv = document.getElementById('ar-gosterici');
        const loader = document.getElementById('loader');
        const TEMEL_KUTU = "https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/BoxTextured/glTF-Binary/BoxTextured.glb";

        async function vitriniGetir() {
            try {
                const cevap = await fetch(`https://raw.githubusercontent.com/${KULLANICI}/${REPO}/main/vitrin.json?t=${Date.now()}`);
                if (cevap.ok) {
                    vitrin = await cevap.json();
                    if(vitrin.length > 0) urunuBas(0);
                    else loader.innerHTML = "<p style='color:white'>Vitrin boş.</p>";
                }
            } catch (e) {}
        }

        async function urunuBas(index) {
            const urun = vitrin[index];
            if (!urun) return;

            // Metinleri Güncelle
            document.getElementById('urun-adi').innerText = urun.ad || "";
            document.getElementById('urun-seri').innerText = urun.seri || "";
            document.getElementById('urun-fiyat').innerText = urun.fiyat || "";
            document.getElementById('urun-olcu').innerText = urun.tip === '3dmodel' ? "3D Model" : `${urun.en}x${urun.boy} cm`;
            
            document.getElementById('wp-link').href = `https://api.whatsapp.com/send?phone=${WP_NUMARA}&text=${encodeURIComponent('Model: ' + urun.ad)}`; 

            // AR MOTORU MANTIK AYRIMI
            try {
                if (urun.tip === '3dmodel') {
                    // GERÇEK 3D OBJELER (.glb dosyaları)
                    mv.src = urun.url;
                    mv.setAttribute('ar-placement', 'floor');
                    mv.scale = "1 1 1";
                } 
                else if (urun.tip === 'tablo') {
                    // TABLO / DUVAR (İnce Kutu + Duvara Yapışma)
                    mv.src = TEMEL_KUTU;
                    mv.setAttribute('ar-placement', 'wall'); // Telefon kamerası duvar arayacak
                    mv.scale = `${urun.en / 100} ${urun.boy / 100} 0.02`; // x, y, z(kalınlık 2cm)
                    await dokuKapla(urun.url);
                } 
                else {
                    // HALI / ZEMİN (Yere Yapışma)
                    mv.src = TEMEL_KUTU;
                    mv.setAttribute('ar-placement', 'floor');
                    mv.scale = `${urun.en / 100} 0.01 ${urun.boy / 100}`; // x, y(kalınlık 1cm), z
                    await dokuKapla(urun.url);
                }
                
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 300);
            } catch (error) { console.log(error); }
        }

        async function dokuKapla(url) {
            // Model Viewer'ın kaplama fonksiyonu
            await new Promise(r => setTimeout(r, 100)); // modelin yüklenmesini bekle
            if (!mv.model || !mv.model.materials) return;
            const texture = await mv.createTexture(url);
            const material = mv.model.materials[0];
            material.pbrMetallicRoughness.baseColorTexture.setTexture(texture);
            material.pbrMetallicRoughness.setBaseColorFactor([1, 1, 1, 1]);
        }

        window.degistir = function(yon) {
            if (vitrin.length === 0) return;
            loader.style.display = 'flex'; loader.style.opacity = '1';
            aktifIndex += yon;
            if (aktifIndex >= vitrin.length) aktifIndex = 0;
            if (aktifIndex < 0) aktifIndex = vitrin.length - 1;
            urunuBas(aktifIndex);
        }

        window.arBaslat = function() { mv.activateAR(); }
        mv.addEventListener('load', vitriniGetir);
        setTimeout(() => { if(vitrin.length===0) vitriniGetir(); }, 1000);
    </script>
</body>
</html>
